# file opened: main.asm
  1   0000              	DEVICE ZXSPECTRUM48
  2   0000
  3   0000              ;	org 2000h
  4   0000                      org 5000h
  5   5000              begin:
  6   5000 C3 0D 52     	jp vktInit
  7   5003 C3 87 54     	jp vktPlay
  8   5006 E6 55        	dw module
  9   5008              	include "player.a80"
# file opened: player.a80
  1+  5008
  2+  5008              ;СКОЛЬКО КАНАЛОВ ИГРАТЬ
  3+  5008              CHANNELS = 3
  4+  5008
  5+  5008              ;===================================================
  6+  5008              ;Basic Vortex Player for vi53
  7+  5008              ;ФОРМАТ vkt
  8+  5008              ;первые 256 байт - адесса патернов, максимум 128 патернов
  9+  5008              ;ПОТОМ 127 БАЙТ ОРДЕЛ ЛИСТ, ПОСЛЕДНИЙ БАЙТ ЭТО КУДА ЛУП С ПОДНЯТЫМ 7-М БИТОМ
 10+  5008              ;храняться по два байта адресв начала каждого патерна
 11+  5008              ;+128 СКОРОСТЬ
 12+  5008
 13+  5008              ;#81 - на какой делать луп
 14+  5008              ;vtkLoop = #81
 15+  5008              ;#82 - скорость трека
 16+  5008              ;vtkSpeed = #82
 17+  5008              ;
 18+  5008              ;commands
 19+  5008              ;if bit 7 is set - enable timer and playNote - note is AND 01111111b
 20+  5008              ;    cmdKeepPlayn equ 0
 21+  5008              ;00 - keep playin
 22+  5008              ;7F change speed - сразу за ней скорость
 23+  5008              cmdSpeed equ #7f
 24+  5008              ;7E - mute chanel (R--)
 25+  5008              cmdMuteCh equ #7e
 26+  5008              ;7D - end of pattern, get new from pat order
 27+  5008              cmdPatChange equ #7d
 28+  5008              ;7C включить орнамент
 29+  5008              cmdOrnament equ #7c
 30+  5008              ;7B применить оффсет на орнамент
 31+  5008              cmdOrnamentOffset equ #7b
 32+  5008              ;7A включить инструмент
 33+  5008              cmdSample equ #7a
 34+  5008              ;79 применить оффсет на инструмент-сэмпл
 35+  5008              cmdSampleOffset equ #79
 36+  5008
 37+  5008 00 00 00...      align 256
 38+  5100              freqTable: incbin "music\freqTable.bin"
 39+  5200
 40+  5200              ;header
 41+  5200              ;===================================================
 42+  5200              ;patterns = module
 43+  5200              ;playOrder = module + 256
 44+  5200              ;ornamentsList = playOrder + 128
 45+  5200              ;samplesList = ornamentsList + 64
 46+  5200              ;notes = samplesList + 128
 47+  5200              ;paterns adresses
 48+  5200              ;256bytes
 49+  5200              ;patterns:
 50+  5200              ;    incbin "music\patterns.bin"
 51+  5200              ;play order
 52+  5200              ;если установлен 7бит то эндом у нас номер патерна для лупа
 53+  5200              ;128bytes
 54+  5200              ;playOrder:
 55+  5200              ;    incbin "music\order.bin"
 56+  5200              ;64 bytes - ornaments descriptors за ними сразу сами орнаменты
 57+  5200              ;ornamentsList:
 58+  5200              ;    incbin "music\ornaments.bin"
 59+  5200              ;===================================================
 60+  5200              ;Табличка с описаниекм Орнаментов
 61+  5200              ;    dup 16
 62+  5200              ;    dw 00000; ornament data addr delta +64 для нулевого а дальше по длине других - всё в препроцессоре
 63+  5200              ;    db 0;loop position
 64+  5200              ;    db 0;end position(length) - when reach it loop to loop position
 65+  5200              ;    edup
 66+  5200              ;===================================================
 67+  5200              ;128 bytes - samples descriptors за ними сразу сами инструменты, структура описателей как у орнаментов
 68+  5200              ;samplesList:
 69+  5200              ;    incbin "music\samples.bin"
 70+  5200              ;notes:
 71+  5200              ;    incbin "music\notes.bin"
 72+  5200              ;===================================================
 73+  5200              ;Player Variables
 74+  5200              vtkVars:
 75+  5200 00 00        patterns:       dw 00000
 76+  5202 00 00        playOrder:      dw 00000
 77+  5204 00 00        ornamentsList:  dw 00000
 78+  5206 00 00        samplesList:    dw 00000
 79+  5208 03           vtkSpeed:       db 3
 80+  5209
 81+  5209 00 00        currentTick:    dw 0
 82+  520B 00           currentPattern:  db 0
 83+  520C 01           speedTick:  db 1
 84+  520D
 85+  520D              ;HL - header16byte + module adress
 86+  520D              ;16 bytes header
 87+  520D              vktInit:
 88+  520D E5               push hl
 89+  520E 11 10 00         ld de,16
 89+  5211 19             add hl,de
 89+  5212 EB             ex hl,de;skip header
 90+  5213 C1               pop bc
 91+  5214
 92+  5214 0A               ld a,(bc)
 92+  5215 6F             ld l,a
 92+  5216 03             inc bc
 92+  5217 0A             ld a,(bc)
 92+  5218 67             ld h,a
 92+  5219 03             inc bc
 93+  521A 19               add hl,de
 93+  521B 22 00 52       ld (patterns),hl
 94+  521E
 95+  521E 0A               ld a,(bc)
 95+  521F 6F             ld l,a
 95+  5220 03             inc bc
 95+  5221 0A             ld a,(bc)
 95+  5222 67             ld h,a
 95+  5223 03             inc bc
 96+  5224 19               add hl,de
 96+  5225 22 02 52       ld (playOrder),hl
 97+  5228
 98+  5228 0A               ld a,(bc)
 98+  5229 6F             ld l,a
 98+  522A 03             inc bc
 98+  522B 0A             ld a,(bc)
 98+  522C 67             ld h,a
 98+  522D 03             inc bc
 99+  522E 19               add hl,de
 99+  522F 22 04 52       ld (ornamentsList),hl
100+  5232
101+  5232 0A               ld a,(bc)
101+  5233 6F             ld l,a
101+  5234 03             inc bc
101+  5235 0A             ld a,(bc)
101+  5236 67             ld h,a
101+  5237 03             inc bc
102+  5238 19               add hl,de
102+  5239 22 06 52       ld (samplesList),hl
103+  523C
104+  523C 0A               ld a,(bc)
104+  523D 6F             ld l,a
104+  523E 03             inc bc
104+  523F 0A             ld a,(bc)
104+  5240 67             ld h,a
104+  5241 03             inc bc
105+  5242 19               add hl,de
105+  5243 22 E2 55       ld (notes),hl
106+  5246                  ;speed
107+  5246 0A               ld a,(bc)
107+  5247 32 08 52       ld (vtkSpeed),a
108+  524A
109+  524A                  ;
110+  524A AF               xor a
110+  524B 32 0B 52       ld (currentPattern),a
111+  524E                  ;==================================================================
112+  524E CD BD 55         call getPatternAddr
112+  5251 22 09 52       ld (currentTick),hl
113+  5254                  ;1-сразу играет первая нота
114+  5254 3E 01            ld a,1
114+  5256 32 0C 52       ld (speedTick),a
115+  5259                  ;включить воспроизведение
116+  5259 AF               xor a
116+  525A 32 87 54       ld (vktPlay),a
117+  525D                  ;почистить NOTES BUFFER
118+  525D 21 91 52         ld hl,notesBuffer
118+  5260 06 18          ld b,CHANNELS*NB_SIZE
119+  5262              clNotesBuffer:
120+  5262 77               ld (hl),a
120+  5263 23             inc hl
120+  5264 05             dec b
120+  5265 C2 62 52       jp nz,clNotesBuffer
121+  5268 C9               ret
122+  5269
123+  5269              vktStop:
124+  5269                  ;запрещаем проигрывание
125+  5269 3E C9            ld a,#c9
125+  526B 32 87 54       ld (vktPlay),a
126+  526E                  ;смотрим, если канал включен то выключаем
127+  526E              CH = #36
128+  526E                  dup CHANNELS
129+  526E             >    ;если канал отключен то скипаем
130+  526E 3A A9 52    >    ld a,(notesBuffer+N*NB_SIZE)
130+  5271 B7          >  or a
130+  5272 CA 48 53    >  jp z,1f
131+  5275             >    ;иначе гасим )
132+  5275 3E 36       >    ld  A,CH     ;выключить канал
133+  5277 D3 08       >    OUT  (08),a       ;
134+  5279             >CH = CH + #40;next ch
129+  5279             >    ;если канал отключен то скипаем
130+  5279 3A A9 52    >    ld a,(notesBuffer+N*NB_SIZE)
130+  527C B7          >  or a
130+  527D CA 48 53    >  jp z,1f
131+  5280             >    ;иначе гасим )
132+  5280 3E 76       >    ld  A,CH     ;выключить канал
133+  5282 D3 08       >    OUT  (08),a       ;
134+  5284             >CH = CH + #40;next ch
129+  5284             >    ;если канал отключен то скипаем
130+  5284 3A A9 52    >    ld a,(notesBuffer+N*NB_SIZE)
130+  5287 B7          >  or a
130+  5288 CA 48 53    >  jp z,1f
131+  528B             >    ;иначе гасим )
132+  528B 3E B6       >    ld  A,CH     ;выключить канал
133+  528D D3 08       >    OUT  (08),a       ;
134+  528F             >CH = CH + #40;next ch
135+  528F                  edup
136+  528F C9               ret
137+  5290
138+  5290              ;00110110 сташие 2 бита номер счетчика
139+  5290
140+  5290              ;036h ;0
141+  5290              ;076h ;1
142+  5290              ;0B6h ;2
143+  5290
144+  5290              ;0-й канал - порт 0Bh, 1-й канал - порт 0Ah, 2-й канал - порт 09h
145+  5290
146+  5290 36           currentCh:    db #36
147+  5291              ;vtkSpeed = playOrder+127
148+  5291
149+  5291
150+  5291              ;fakeOrnament: db +1,+19,0,0,0,0,0,0
151+  5291              ;fakeInstrument: dw 2000,3000,2000,-2000,-3000,-2000
152+  5291              ;какую ноту сувать в какой канал
153+  5291              NB_SIZE=8
154+  5291              notesBuffer:
155+  5291                      dup CHANNELS
156+  5291 00          >        db 0;0-канал выключен 1-канал включен
157+  5292 00          >        db 0;индекс ноты какую играем
158+  5293             >;===========================================================================================
159+  5293 00          >        db 0;какой орнамент применяем, если 0 то никакой, нет нулевого орнамента )
160+  5294 00          >        db 0;ornament start +3
161+  5295 00          >        db 0;ornament counter внутренний счетчик по орнаменту,тут или 0 при ините орнамента или тот который командой 5 задали, loop,end позиции берем из орнамента   +4
162+  5296             >;===========================================================================================
163+  5296 00          >        db 0;какой инструмент применили +5
164+  5297 00          >        db 0;sample start +6
165+  5298 00          >        db 0;sample counter внутренний счетчик по сэмплу,тут или 0 при ините орнамента или тот который командой 4 задали, loop,end позиции берем из инструмента   +7
166+  5299             >;===========================================================================================
156+  5299 00          >        db 0;0-канал выключен 1-канал включен
157+  529A 00          >        db 0;индекс ноты какую играем
158+  529B             >;===========================================================================================
159+  529B 00          >        db 0;какой орнамент применяем, если 0 то никакой, нет нулевого орнамента )
160+  529C 00          >        db 0;ornament start +3
161+  529D 00          >        db 0;ornament counter внутренний счетчик по орнаменту,тут или 0 при ините орнамента или тот который командой 5 задали, loop,end позиции берем из орнамента   +4
162+  529E             >;===========================================================================================
163+  529E 00          >        db 0;какой инструмент применили +5
164+  529F 00          >        db 0;sample start +6
165+  52A0 00          >        db 0;sample counter внутренний счетчик по сэмплу,тут или 0 при ините орнамента или тот который командой 4 задали, loop,end позиции берем из инструмента   +7
166+  52A1             >;===========================================================================================
156+  52A1 00          >        db 0;0-канал выключен 1-канал включен
157+  52A2 00          >        db 0;индекс ноты какую играем
158+  52A3             >;===========================================================================================
159+  52A3 00          >        db 0;какой орнамент применяем, если 0 то никакой, нет нулевого орнамента )
160+  52A4 00          >        db 0;ornament start +3
161+  52A5 00          >        db 0;ornament counter внутренний счетчик по орнаменту,тут или 0 при ините орнамента или тот который командой 5 задали, loop,end позиции берем из орнамента   +4
162+  52A6             >;===========================================================================================
163+  52A6 00          >        db 0;какой инструмент применили +5
164+  52A7 00          >        db 0;sample start +6
165+  52A8 00          >        db 0;sample counter внутренний счетчик по сэмплу,тут или 0 при ините орнамента или тот который командой 4 задали, loop,end позиции берем из инструмента   +7
166+  52A9             >;===========================================================================================
167+  52A9                      edup
168+  52A9
169+  52A9              vktProcess:
170+  52A9              N=0
171+  52A9              PORT=#0b
172+  52A9              STFU=#36 ; #b6 ; 36 76 b6
173+  52A9                  dup CHANNELS
174+  52A9             >    ;если канал отключен то скипаем
175+  52A9 3A 91 52    >    ld a,(notesBuffer+N*NB_SIZE)
175+  52AC B7          >  or a
175+  52AD CA 48 53    >  jp z,1f
176+  52B0             >    ;ок, канал включен
177+  52B0             >    ;дельта по-умолчанию
178+  52B0 0E 00       >    ld c,0
179+  52B2             >    ;смотрим включен ли орнамент
180+  52B2             >    ;если нет то скипаем
181+  52B2 3A 93 52    >    ld a,(notesBuffer+N*NB_SIZE+2)
181+  52B5 B7          >  or a
181+  52B6 CA E2 52    >  jp z,2f
182+  52B9             >
183+  52B9             >  ;  jp 2f
184+  52B9             >
185+  52B9             >    ;описание одного орнамента 4 байта
186+  52B9 87          >    add a,a
186+  52BA 87          >  add a,a
186+  52BB 5F          >  ld e,a
186+  52BC 16 00       >  ld d,0
187+  52BE 2A 04 52    >    ld hl,(ornamentsList)
187+  52C1 19          >  add hl,de
188+  52C2             >    ;теперь hl указывает на нужный нам орнамент
189+  52C2             >    ;в de начало значений дельт в орнаменте
190+  52C2 5E          >    ld e,(hl)
190+  52C3 23          >  inc hl
190+  52C4 56          >  ld d,(hl)
190+  52C5 23          >  inc hl
191+  52C6             >    ;в l-loop position в h-length
192+  52C6 7E          >    ld a,(hl)
192+  52C7 23          >  inc hl
192+  52C8 66          >  ld h,(hl)
192+  52C9 6F          >  ld l,a
193+  52CA             >    ;берем счеткик орнамента для канала
194+  52CA 3A 95 52    >    ld a,(notesBuffer+N*NB_SIZE+4)
194+  52CD 47          >  ld b,a
195+  52CE             >    ;шагаем счётк орнамента и лупим если надо
196+  52CE 3C          >    inc a
197+  52CF             >    ;если дошли до конца то на луп прыгаем
198+  52CF BC          >    cp h
199+  52D0 C2 D4 52    >    jp nz,8f;не дошли до конца просто дальше идём
200+  52D3             >7:
201+  52D3             >    ;ок, дошли до конца, прыгаем на луп
202+  52D3 7D          >    ld a,l
203+  52D4             >8:
204+  52D4             >    ;сохраняем новое значение счетчика
205+  52D4 32 95 52    >    ld (notesBuffer+N*NB_SIZE+4),a
206+  52D7             >    ;но играем текущее
207+  52D7 78          >    ld a,b
208+  52D8             >    ;берём дельту из орнамента
209+  52D8 6F          >    ld l,a
209+  52D9 26 00       >  ld h,0
209+  52DB 19          >  add hl,de
209+  52DC EB          >  ex hl,de
210+  52DD 2A 04 52    >    ld hl,(ornamentsList)
210+  52E0 19          >  add hl,de
211+  52E1 4E          >    ld c,(hl)
212+  52E2             >2:
213+  52E2             >    ;берём ноту
214+  52E2 3A 92 52    >    ld a,(notesBuffer+N*NB_SIZE+1)
215+  52E5 B7          >    or a
216+  52E6 81          >    add c;добавляем дельту из орнамента
217+  52E7             >;===============================================================
218+  52E7             >;если нота ниже C-1(4) то делаем её C-1(4)
219+  52E7 C6 04       >    add 4
220+  52E9 FA F1 52    >    jp m,6f
221+  52EC D6 04       >    sub 4
221+  52EE C3 F3 52    >  jp 5f
222+  52F1             >6:
223+  52F1 3E 04       >    ld a,4
224+  52F3             >5:
225+  52F3             >;===============================================================
226+  52F3             >    ;читаем частоту из таблицы нот
227+  52F3 26 51       >    ld h,high freqTable
227+  52F5 87          >  add a,a
227+  52F6 6F          >  ld l,a
228+  52F7 7E          >    ld  a,(hl)
228+  52F8 2C          >  inc l
228+  52F9 66          >  ld h,(hl)
228+  52FA 6F          >  ld l,a
229+  52FB             >    ;сохраняем в стек
230+  52FB E5          >    push hl
231+  52FC 01 00 00    >    ld bc,00000;default delta
232+  52FF             >
233+  52FF             >    ;смотрим включен ли инструмент, если что берем из него дельту
234+  52FF 3A 96 52    >    ld a,(notesBuffer+N*NB_SIZE+5)
234+  5302 B7          >  or a
234+  5303 CA 32 53    >  jp z,2f
235+  5306             >
236+  5306             >  ;  jp 2f
237+  5306             >;    ld (Border),a
238+  5306             >
239+  5306             >    ;описание одного инструмента 4 байта
240+  5306 87          >    add a,a
240+  5307 87          >  add a,a
240+  5308 5F          >  ld e,a
240+  5309 16 00       >  ld d,0
241+  530B 2A 06 52    >    ld hl,(samplesList)
241+  530E 19          >  add hl,de
242+  530F             >    ;теперь hl указывает на нужный нам инструмент
243+  530F             >    ;в de начало значений дельт в инструменте
244+  530F 5E          >    ld e,(hl)
244+  5310 23          >  inc hl
244+  5311 56          >  ld d,(hl)
244+  5312 23          >  inc hl
245+  5313             >    ;в l-loop position в h-length
246+  5313 7E          >    ld a,(hl)
246+  5314 23          >  inc hl
246+  5315 66          >  ld h,(hl)
246+  5316 6F          >  ld l,a
247+  5317             >    ;берем счеткик инструмента для канала
248+  5317 3A 98 52    >    ld a,(notesBuffer+N*NB_SIZE+7)
248+  531A 47          >  ld b,a
249+  531B             >    ;шагаем счётк и лупим если надо
250+  531B 3C          >    inc a
251+  531C             >    ;если дошли до конца то на луп прыгаем
252+  531C BC          >    cp h
253+  531D C2 21 53    >    jp nz,8f;не дошли до конца просто дальше идём
254+  5320             >7:
255+  5320             >    ;ок, дошли до конца, прыгаем на луп
256+  5320 7D          >    ld a,l
257+  5321             >8:
258+  5321             >    ;сохраняем новое значение счетчика
259+  5321 32 98 52    >    ld (notesBuffer+N*NB_SIZE+7),a
260+  5324             >    ;но играем текущее
261+  5324 78          >    ld a,b
262+  5325             >    ;берём дельту из инструмента
263+  5325             >    ;### or a
264+  5325 87          >    add a,a; у нас частота в два байта
265+  5326 6F          >    ld l,a
265+  5327 26 00       >  ld h,0
265+  5329 19          >  add hl,de
265+  532A EB          >  ex hl,de
266+  532B 2A 06 52    >    ld hl,(samplesList)
266+  532E 19          >  add hl,de
267+  532F 4E          >    ld c,(hl)
267+  5330 23          >  inc hl
267+  5331 46          >  ld b,(hl)
268+  5332             >2:
269+  5332 E1          >    pop hl;восстанавливаем частоту
270+  5333             >
271+  5333             >
272+  5333 03          >    inc bc
273+  5334 78          >    ld a, b
273+  5335 B1          >  or c
273+  5336 C2 40 53    >  jp nz, 12f
274+  5339             >11: ; zero means stfu
275+  5339 3E 36       >    ld  a, STFU     ;выключить канал
276+  533B D3 08       >    OUT  (08),a       ;
277+  533D             >    ;ld hl,(chBuffer) : ld (hl),0;disable ch
278+  533D C3 48 53    >    jp 1f
279+  5340             >12:
280+  5340 0B          >    dec bc
281+  5341 09          >    add hl,bc;докидываем смещение из инструмента
282+  5342             >    ;пишем в порт###
283+  5342 7D          >    ld a,l
283+  5343 D3 0B       >  OUT  (PORT),a
284+  5345 7C          >    ld a,h
284+  5346 D3 0B       >  OUT  (PORT),a
285+  5348             >    ;ld  a,(hl)
286+  5348             >    ;OUT  (PORT),a
287+  5348             >    ;inc l : ld A,(hl)
288+  5348             >    ;OUT  (PORT),a
289+  5348             >1:
290+  5348             >N=N+1
291+  5348             >PORT=PORT-1
292+  5348             >STFU=STFU+#40
174+  5348             >    ;если канал отключен то скипаем
175+  5348 3A 99 52    >    ld a,(notesBuffer+N*NB_SIZE)
175+  534B B7          >  or a
175+  534C CA E7 53    >  jp z,1f
176+  534F             >    ;ок, канал включен
177+  534F             >    ;дельта по-умолчанию
178+  534F 0E 00       >    ld c,0
179+  5351             >    ;смотрим включен ли орнамент
180+  5351             >    ;если нет то скипаем
181+  5351 3A 9B 52    >    ld a,(notesBuffer+N*NB_SIZE+2)
181+  5354 B7          >  or a
181+  5355 CA 81 53    >  jp z,2f
182+  5358             >
183+  5358             >  ;  jp 2f
184+  5358             >
185+  5358             >    ;описание одного орнамента 4 байта
186+  5358 87          >    add a,a
186+  5359 87          >  add a,a
186+  535A 5F          >  ld e,a
186+  535B 16 00       >  ld d,0
187+  535D 2A 04 52    >    ld hl,(ornamentsList)
187+  5360 19          >  add hl,de
188+  5361             >    ;теперь hl указывает на нужный нам орнамент
189+  5361             >    ;в de начало значений дельт в орнаменте
190+  5361 5E          >    ld e,(hl)
190+  5362 23          >  inc hl
190+  5363 56          >  ld d,(hl)
190+  5364 23          >  inc hl
191+  5365             >    ;в l-loop position в h-length
192+  5365 7E          >    ld a,(hl)
192+  5366 23          >  inc hl
192+  5367 66          >  ld h,(hl)
192+  5368 6F          >  ld l,a
193+  5369             >    ;берем счеткик орнамента для канала
194+  5369 3A 9D 52    >    ld a,(notesBuffer+N*NB_SIZE+4)
194+  536C 47          >  ld b,a
195+  536D             >    ;шагаем счётк орнамента и лупим если надо
196+  536D 3C          >    inc a
197+  536E             >    ;если дошли до конца то на луп прыгаем
198+  536E BC          >    cp h
199+  536F C2 73 53    >    jp nz,8f;не дошли до конца просто дальше идём
200+  5372             >7:
201+  5372             >    ;ок, дошли до конца, прыгаем на луп
202+  5372 7D          >    ld a,l
203+  5373             >8:
204+  5373             >    ;сохраняем новое значение счетчика
205+  5373 32 9D 52    >    ld (notesBuffer+N*NB_SIZE+4),a
206+  5376             >    ;но играем текущее
207+  5376 78          >    ld a,b
208+  5377             >    ;берём дельту из орнамента
209+  5377 6F          >    ld l,a
209+  5378 26 00       >  ld h,0
209+  537A 19          >  add hl,de
209+  537B EB          >  ex hl,de
210+  537C 2A 04 52    >    ld hl,(ornamentsList)
210+  537F 19          >  add hl,de
211+  5380 4E          >    ld c,(hl)
212+  5381             >2:
213+  5381             >    ;берём ноту
214+  5381 3A 9A 52    >    ld a,(notesBuffer+N*NB_SIZE+1)
215+  5384 B7          >    or a
216+  5385 81          >    add c;добавляем дельту из орнамента
217+  5386             >;===============================================================
218+  5386             >;если нота ниже C-1(4) то делаем её C-1(4)
219+  5386 C6 04       >    add 4
220+  5388 FA 90 53    >    jp m,6f
221+  538B D6 04       >    sub 4
221+  538D C3 92 53    >  jp 5f
222+  5390             >6:
223+  5390 3E 04       >    ld a,4
224+  5392             >5:
225+  5392             >;===============================================================
226+  5392             >    ;читаем частоту из таблицы нот
227+  5392 26 51       >    ld h,high freqTable
227+  5394 87          >  add a,a
227+  5395 6F          >  ld l,a
228+  5396 7E          >    ld  a,(hl)
228+  5397 2C          >  inc l
228+  5398 66          >  ld h,(hl)
228+  5399 6F          >  ld l,a
229+  539A             >    ;сохраняем в стек
230+  539A E5          >    push hl
231+  539B 01 00 00    >    ld bc,00000;default delta
232+  539E             >
233+  539E             >    ;смотрим включен ли инструмент, если что берем из него дельту
234+  539E 3A 9E 52    >    ld a,(notesBuffer+N*NB_SIZE+5)
234+  53A1 B7          >  or a
234+  53A2 CA D1 53    >  jp z,2f
235+  53A5             >
236+  53A5             >  ;  jp 2f
237+  53A5             >;    ld (Border),a
238+  53A5             >
239+  53A5             >    ;описание одного инструмента 4 байта
240+  53A5 87          >    add a,a
240+  53A6 87          >  add a,a
240+  53A7 5F          >  ld e,a
240+  53A8 16 00       >  ld d,0
241+  53AA 2A 06 52    >    ld hl,(samplesList)
241+  53AD 19          >  add hl,de
242+  53AE             >    ;теперь hl указывает на нужный нам инструмент
243+  53AE             >    ;в de начало значений дельт в инструменте
244+  53AE 5E          >    ld e,(hl)
244+  53AF 23          >  inc hl
244+  53B0 56          >  ld d,(hl)
244+  53B1 23          >  inc hl
245+  53B2             >    ;в l-loop position в h-length
246+  53B2 7E          >    ld a,(hl)
246+  53B3 23          >  inc hl
246+  53B4 66          >  ld h,(hl)
246+  53B5 6F          >  ld l,a
247+  53B6             >    ;берем счеткик инструмента для канала
248+  53B6 3A A0 52    >    ld a,(notesBuffer+N*NB_SIZE+7)
248+  53B9 47          >  ld b,a
249+  53BA             >    ;шагаем счётк и лупим если надо
250+  53BA 3C          >    inc a
251+  53BB             >    ;если дошли до конца то на луп прыгаем
252+  53BB BC          >    cp h
253+  53BC C2 C0 53    >    jp nz,8f;не дошли до конца просто дальше идём
254+  53BF             >7:
255+  53BF             >    ;ок, дошли до конца, прыгаем на луп
256+  53BF 7D          >    ld a,l
257+  53C0             >8:
258+  53C0             >    ;сохраняем новое значение счетчика
259+  53C0 32 A0 52    >    ld (notesBuffer+N*NB_SIZE+7),a
260+  53C3             >    ;но играем текущее
261+  53C3 78          >    ld a,b
262+  53C4             >    ;берём дельту из инструмента
263+  53C4             >    ;### or a
264+  53C4 87          >    add a,a; у нас частота в два байта
265+  53C5 6F          >    ld l,a
265+  53C6 26 00       >  ld h,0
265+  53C8 19          >  add hl,de
265+  53C9 EB          >  ex hl,de
266+  53CA 2A 06 52    >    ld hl,(samplesList)
266+  53CD 19          >  add hl,de
267+  53CE 4E          >    ld c,(hl)
267+  53CF 23          >  inc hl
267+  53D0 46          >  ld b,(hl)
268+  53D1             >2:
269+  53D1 E1          >    pop hl;восстанавливаем частоту
270+  53D2             >
271+  53D2             >
272+  53D2 03          >    inc bc
273+  53D3 78          >    ld a, b
273+  53D4 B1          >  or c
273+  53D5 C2 DF 53    >  jp nz, 12f
274+  53D8             >11: ; zero means stfu
275+  53D8 3E 76       >    ld  a, STFU     ;выключить канал
276+  53DA D3 08       >    OUT  (08),a       ;
277+  53DC             >    ;ld hl,(chBuffer) : ld (hl),0;disable ch
278+  53DC C3 E7 53    >    jp 1f
279+  53DF             >12:
280+  53DF 0B          >    dec bc
281+  53E0 09          >    add hl,bc;докидываем смещение из инструмента
282+  53E1             >    ;пишем в порт###
283+  53E1 7D          >    ld a,l
283+  53E2 D3 0A       >  OUT  (PORT),a
284+  53E4 7C          >    ld a,h
284+  53E5 D3 0A       >  OUT  (PORT),a
285+  53E7             >    ;ld  a,(hl)
286+  53E7             >    ;OUT  (PORT),a
287+  53E7             >    ;inc l : ld A,(hl)
288+  53E7             >    ;OUT  (PORT),a
289+  53E7             >1:
290+  53E7             >N=N+1
291+  53E7             >PORT=PORT-1
292+  53E7             >STFU=STFU+#40
174+  53E7             >    ;если канал отключен то скипаем
175+  53E7 3A A1 52    >    ld a,(notesBuffer+N*NB_SIZE)
175+  53EA B7          >  or a
175+  53EB CA 86 54    >  jp z,1f
176+  53EE             >    ;ок, канал включен
177+  53EE             >    ;дельта по-умолчанию
178+  53EE 0E 00       >    ld c,0
179+  53F0             >    ;смотрим включен ли орнамент
180+  53F0             >    ;если нет то скипаем
181+  53F0 3A A3 52    >    ld a,(notesBuffer+N*NB_SIZE+2)
181+  53F3 B7          >  or a
181+  53F4 CA 20 54    >  jp z,2f
182+  53F7             >
183+  53F7             >  ;  jp 2f
184+  53F7             >
185+  53F7             >    ;описание одного орнамента 4 байта
186+  53F7 87          >    add a,a
186+  53F8 87          >  add a,a
186+  53F9 5F          >  ld e,a
186+  53FA 16 00       >  ld d,0
187+  53FC 2A 04 52    >    ld hl,(ornamentsList)
187+  53FF 19          >  add hl,de
188+  5400             >    ;теперь hl указывает на нужный нам орнамент
189+  5400             >    ;в de начало значений дельт в орнаменте
190+  5400 5E          >    ld e,(hl)
190+  5401 23          >  inc hl
190+  5402 56          >  ld d,(hl)
190+  5403 23          >  inc hl
191+  5404             >    ;в l-loop position в h-length
192+  5404 7E          >    ld a,(hl)
192+  5405 23          >  inc hl
192+  5406 66          >  ld h,(hl)
192+  5407 6F          >  ld l,a
193+  5408             >    ;берем счеткик орнамента для канала
194+  5408 3A A5 52    >    ld a,(notesBuffer+N*NB_SIZE+4)
194+  540B 47          >  ld b,a
195+  540C             >    ;шагаем счётк орнамента и лупим если надо
196+  540C 3C          >    inc a
197+  540D             >    ;если дошли до конца то на луп прыгаем
198+  540D BC          >    cp h
199+  540E C2 12 54    >    jp nz,8f;не дошли до конца просто дальше идём
200+  5411             >7:
201+  5411             >    ;ок, дошли до конца, прыгаем на луп
202+  5411 7D          >    ld a,l
203+  5412             >8:
204+  5412             >    ;сохраняем новое значение счетчика
205+  5412 32 A5 52    >    ld (notesBuffer+N*NB_SIZE+4),a
206+  5415             >    ;но играем текущее
207+  5415 78          >    ld a,b
208+  5416             >    ;берём дельту из орнамента
209+  5416 6F          >    ld l,a
209+  5417 26 00       >  ld h,0
209+  5419 19          >  add hl,de
209+  541A EB          >  ex hl,de
210+  541B 2A 04 52    >    ld hl,(ornamentsList)
210+  541E 19          >  add hl,de
211+  541F 4E          >    ld c,(hl)
212+  5420             >2:
213+  5420             >    ;берём ноту
214+  5420 3A A2 52    >    ld a,(notesBuffer+N*NB_SIZE+1)
215+  5423 B7          >    or a
216+  5424 81          >    add c;добавляем дельту из орнамента
217+  5425             >;===============================================================
218+  5425             >;если нота ниже C-1(4) то делаем её C-1(4)
219+  5425 C6 04       >    add 4
220+  5427 FA 2F 54    >    jp m,6f
221+  542A D6 04       >    sub 4
221+  542C C3 31 54    >  jp 5f
222+  542F             >6:
223+  542F 3E 04       >    ld a,4
224+  5431             >5:
225+  5431             >;===============================================================
226+  5431             >    ;читаем частоту из таблицы нот
227+  5431 26 51       >    ld h,high freqTable
227+  5433 87          >  add a,a
227+  5434 6F          >  ld l,a
228+  5435 7E          >    ld  a,(hl)
228+  5436 2C          >  inc l
228+  5437 66          >  ld h,(hl)
228+  5438 6F          >  ld l,a
229+  5439             >    ;сохраняем в стек
230+  5439 E5          >    push hl
231+  543A 01 00 00    >    ld bc,00000;default delta
232+  543D             >
233+  543D             >    ;смотрим включен ли инструмент, если что берем из него дельту
234+  543D 3A A6 52    >    ld a,(notesBuffer+N*NB_SIZE+5)
234+  5440 B7          >  or a
234+  5441 CA 70 54    >  jp z,2f
235+  5444             >
236+  5444             >  ;  jp 2f
237+  5444             >;    ld (Border),a
238+  5444             >
239+  5444             >    ;описание одного инструмента 4 байта
240+  5444 87          >    add a,a
240+  5445 87          >  add a,a
240+  5446 5F          >  ld e,a
240+  5447 16 00       >  ld d,0
241+  5449 2A 06 52    >    ld hl,(samplesList)
241+  544C 19          >  add hl,de
242+  544D             >    ;теперь hl указывает на нужный нам инструмент
243+  544D             >    ;в de начало значений дельт в инструменте
244+  544D 5E          >    ld e,(hl)
244+  544E 23          >  inc hl
244+  544F 56          >  ld d,(hl)
244+  5450 23          >  inc hl
245+  5451             >    ;в l-loop position в h-length
246+  5451 7E          >    ld a,(hl)
246+  5452 23          >  inc hl
246+  5453 66          >  ld h,(hl)
246+  5454 6F          >  ld l,a
247+  5455             >    ;берем счеткик инструмента для канала
248+  5455 3A A8 52    >    ld a,(notesBuffer+N*NB_SIZE+7)
248+  5458 47          >  ld b,a
249+  5459             >    ;шагаем счётк и лупим если надо
250+  5459 3C          >    inc a
251+  545A             >    ;если дошли до конца то на луп прыгаем
252+  545A BC          >    cp h
253+  545B C2 5F 54    >    jp nz,8f;не дошли до конца просто дальше идём
254+  545E             >7:
255+  545E             >    ;ок, дошли до конца, прыгаем на луп
256+  545E 7D          >    ld a,l
257+  545F             >8:
258+  545F             >    ;сохраняем новое значение счетчика
259+  545F 32 A8 52    >    ld (notesBuffer+N*NB_SIZE+7),a
260+  5462             >    ;но играем текущее
261+  5462 78          >    ld a,b
262+  5463             >    ;берём дельту из инструмента
263+  5463             >    ;### or a
264+  5463 87          >    add a,a; у нас частота в два байта
265+  5464 6F          >    ld l,a
265+  5465 26 00       >  ld h,0
265+  5467 19          >  add hl,de
265+  5468 EB          >  ex hl,de
266+  5469 2A 06 52    >    ld hl,(samplesList)
266+  546C 19          >  add hl,de
267+  546D 4E          >    ld c,(hl)
267+  546E 23          >  inc hl
267+  546F 46          >  ld b,(hl)
268+  5470             >2:
269+  5470 E1          >    pop hl;восстанавливаем частоту
270+  5471             >
271+  5471             >
272+  5471 03          >    inc bc
273+  5472 78          >    ld a, b
273+  5473 B1          >  or c
273+  5474 C2 7E 54    >  jp nz, 12f
274+  5477             >11: ; zero means stfu
275+  5477 3E B6       >    ld  a, STFU     ;выключить канал
276+  5479 D3 08       >    OUT  (08),a       ;
277+  547B             >    ;ld hl,(chBuffer) : ld (hl),0;disable ch
278+  547B C3 86 54    >    jp 1f
279+  547E             >12:
280+  547E 0B          >    dec bc
281+  547F 09          >    add hl,bc;докидываем смещение из инструмента
282+  5480             >    ;пишем в порт###
283+  5480 7D          >    ld a,l
283+  5481 D3 09       >  OUT  (PORT),a
284+  5483 7C          >    ld a,h
284+  5484 D3 09       >  OUT  (PORT),a
285+  5486             >    ;ld  a,(hl)
286+  5486             >    ;OUT  (PORT),a
287+  5486             >    ;inc l : ld A,(hl)
288+  5486             >    ;OUT  (PORT),a
289+  5486             >1:
290+  5486             >N=N+1
291+  5486             >PORT=PORT-1
292+  5486             >STFU=STFU+#40
293+  5486                  edup
294+  5486 C9               ret
295+  5487
296+  5487              vktPlay:
297+  5487 C9               ret
298+  5488                  ;сначала играем в буффер
299+  5488 CD 8E 54         call vktDoTick
300+  548B                  ;применяя орнаменты и инструменты итп  и шлём всё в ВИ53
301+  548B C3 A9 52         jp vktProcess
302+  548E
303+  548E              vktDoTick:
304+  548E                  ;speed
305+  548E 3A 0C 52         ld a,(speedTick)
305+  5491 3D             dec a
305+  5492 32 0C 52       ld (speedTick),a
306+  5495 B7               or a
306+  5496 C0             ret nz
307+  5497 3A 08 52         ld a,(vtkSpeed)
307+  549A 32 0C 52       ld (speedTick),a
308+  549D                  ;отслеживаем смену патерна
309+  549D 2A 09 52         ld hl,(currentTick)
310+  54A0                  ;читаем команду или ноту
311+  54A0 7E               ld a,(hl)
312+  54A1                  ;команда смены патерна
313+  54A1 FE 7D            cp cmdPatChange
313+  54A3 C2 AC 54       jp nz,1f
314+  54A6                  ;ld a,2 : call getPatternAddr : ld (currentTick),hl
315+  54A6 CD B6 55         call getNextPatternAddr
315+  54A9 22 09 52       ld (currentTick),hl
316+  54AC              1:
317+  54AC                  ;ch 1
318+  54AC 21 91 52         ld hl,notesBuffer+0*NB_SIZE
318+  54AF 22 A5 55       ld (chBuffer),hl
319+  54B2 21 93 52         ld hl,notesBuffer+0*NB_SIZE+2
319+  54B5 22 34 55       ld (chOrnaments),hl
320+  54B8 21 96 52         ld hl,notesBuffer+0*NB_SIZE+5
320+  54BB 22 67 55       ld (chSamples),hl
321+  54BE 3E 36            ld a,#36
321+  54C0 32 90 52       ld (currentCh),a
322+  54C3 CD FB 54         call vktPlayCh
323+  54C6              	IF CHANNELS>1
324+  54C6                  ;ch 2
325+  54C6 21 99 52         ld hl,notesBuffer+1*NB_SIZE
325+  54C9 22 A5 55       ld (chBuffer),hl
326+  54CC 21 9B 52         ld hl,notesBuffer+1*NB_SIZE+2
326+  54CF 22 34 55       ld (chOrnaments),hl
327+  54D2 21 9E 52         ld hl,notesBuffer+1*NB_SIZE+5
327+  54D5 22 67 55       ld (chSamples),hl
328+  54D8 3E 76            ld a,#76
328+  54DA 32 90 52       ld (currentCh),a
329+  54DD CD FB 54         call vktPlayCh
330+  54E0              	ENDIF
331+  54E0
332+  54E0              	IF CHANNELS>2
333+  54E0                  ;ch 3
334+  54E0 21 A1 52         ld hl,notesBuffer+2*NB_SIZE
334+  54E3 22 A5 55       ld (chBuffer),hl
335+  54E6 21 A3 52         ld hl,notesBuffer+2*NB_SIZE+2
335+  54E9 22 34 55       ld (chOrnaments),hl
336+  54EC 21 A6 52         ld hl,notesBuffer+2*NB_SIZE+5
336+  54EF 22 67 55       ld (chSamples),hl
337+  54F2 3E B6            ld a,#b6
337+  54F4 32 90 52       ld (currentCh),a
338+  54F7 CD FB 54         call vktPlayCh
339+  54FA              	ENDIF
340+  54FA C9               ret
341+  54FB
342+  54FB              vktPlayCh:
343+  54FB 2A 09 52         ld hl,(currentTick)
344+  54FE              2:
345+  54FE                  ;читаем команду или ноту
346+  54FE 7E               ld a,(hl)
347+  54FF              ;====================================================
348+  54FF                  ;команда изменения скорости
349+  54FF FE 7F            cp cmdSpeed
349+  5501 C2 10 55       jp nz,1f
350+  5504                  ;меняем скорость
351+  5504 23               inc hl
351+  5505 7E             ld a,(hl)
351+  5506 32 08 52       ld (vtkSpeed),a
351+  5509 23             inc hl
351+  550A 22 09 52       ld (currentTick),hl
352+  550D C3 FE 54         jp 2b
353+  5510              1:
354+  5510              ;====================================================
355+  5510                  ;команда оффсета для орнамента
356+  5510 FE 7B            cp cmdOrnamentOffset
356+  5512 C2 28 55       jp nz,1f
357+  5515 23               inc hl
357+  5516 7E             ld a,(hl)
357+  5517 23             inc hl
357+  5518 22 09 52       ld (currentTick),hl
358+  551B                  ;ld hl,(chBuffer) :  inc hl : inc hl : inc hl  : ld (hl),a
359+  551B 2A 34 55         ld hl,(chOrnaments)
359+  551E 23              inc hl
359+  551F 77             ld (hl),a
360+  5520                  ;вроде команда не инициализирует орнамент судя по докам, но проинитим, если что закоментить строчку ниже
361+  5520 23               inc hl
361+  5521 77             ld (hl),a
362+  5522                  ;ld (Border),a
363+  5522 2A 09 52         ld hl,(currentTick)
364+  5525                  ;cp 3 : jp z,0
365+  5525 C3 FE 54         jp 2b
366+  5528              1:
367+  5528              ;====================================================
368+  5528                  ;Включить орнамент на текущий канал
369+  5528 FE 7C            cp cmdOrnament
369+  552A C2 43 55       jp nz,1f
370+  552D                  ;читаем номер орнамента и включаем его к текущему каналу
371+  552D 23               inc hl
371+  552E 7E             ld a,(hl)
371+  552F 23             inc hl
371+  5530 22 09 52       ld (currentTick),hl
372+  5533                  ;ld hl,(chBuffer) : inc hl : inc hl : ld (hl),a
373+  5533              chOrnaments equ $+1
374+  5533 21 00 00          ld hl,00000
374+  5536 77             ld (hl),a
375+  5537                  ;сбрасываем счетчик на 0
376+  5537 23               inc hl
377+  5538 36 00            ld (hl),0
378+  553A 23               inc hl
379+  553B                  ;офсет тоже на ноль, команда 5 если что скорректирует
380+  553B 36 00            ld (hl),0;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
381+  553D 2A 09 52         ld hl,(currentTick);восстанавливаем счетчик
382+  5540 C3 FE 54         jp 2b
383+  5543              1:
384+  5543              ;====================================================
385+  5543                  ;команда оффсета для инструмента-сэмпла
386+  5543 FE 79            cp cmdSampleOffset
386+  5545 C2 5B 55       jp nz,1f
387+  5548 23               inc hl
387+  5549 7E             ld a,(hl)
387+  554A 23             inc hl
387+  554B 22 09 52       ld (currentTick),hl
388+  554E                  ;ld hl,(chBuffer) :  inc hl : inc hl : inc hl  : ld (hl),a
389+  554E 2A 67 55         ld hl,(chSamples)
389+  5551 23              inc hl
389+  5552 77             ld (hl),a
390+  5553                  ;вроде команда не инициализирует инструмент, но это скорре всего про не сброс накопления, если что закоментить строчку ниже
391+  5553 23               inc hl
391+  5554 77             ld (hl),a
392+  5555                  ;мигнём офсетом
393+  5555                  ;ld (Border),a
394+  5555 2A 09 52         ld hl,(currentTick)
395+  5558 C3 FE 54         jp 2b
396+  555B              1:
397+  555B              ;====================================================
398+  555B                  ;Включить сэмпл на текущий канал
399+  555B FE 7A            cp cmdSample
399+  555D C2 76 55       jp nz,1f
400+  5560                  ;читаем номер орнамента и включаем его к текущему каналу
401+  5560 23               inc hl
401+  5561 7E             ld a,(hl)
401+  5562 23             inc hl
401+  5563 22 09 52       ld (currentTick),hl
402+  5566                  //Сохраняем номер сэмпла
403+  5566              chSamples equ $+1
404+  5566 21 00 00         ld hl,00000
404+  5569 77             ld (hl),a
405+  556A                  ;мигнём номером сэмпла
406+  556A                  ;ld (Border),a
407+  556A                  ;сбрасываем счетчик на 0
408+  556A 23               inc hl
409+  556B 36 00            ld (hl),0
410+  556D 23               inc hl
411+  556E                  ;офсет тоже на ноль, команда 5 если что скорректирует
412+  556E 36 00            ld (hl),0;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
413+  5570
414+  5570 2A 09 52         ld hl,(currentTick);восстанавливаем счетчик
415+  5573 C3 FE 54         jp 2b
416+  5576              ;====================================================
417+  5576              1:
418+  5576                  ;команда отключения канала
419+  5576 FE 7E            cp cmdMuteCh
419+  5578 CA 87 55       jp z,disableTimer
420+  557B                  ;ничего не менялось?
421+  557B B7               or a
421+  557C CA AE 55       jp z,nextNote
422+  557F                  ;если установлен 7-ой бит то включаем таймер и играем ноту - индекс ноты это значение без 7-го бита
423+  557F 17               rla
423+  5580 DA 94 55       jp c,enableTimer
424+  5583                  ;ок просто изменение частоты
425+  5583 7E               ld a,(hl)
425+  5584 C3 A4 55       jp playNote
426+  5587              disableTimer:
427+  5587 3A 90 52         ld  A,(currentCh)     ;выключить канал
428+  558A D3 08            OUT  (08),a       ;
429+  558C 2A A5 55         ld hl,(chBuffer)
429+  558F 36 00          ld (hl),0;disable ch
430+  5591 C3 AE 55         jp nextNote       ;перейти к следующей ноте
431+  5594              enableTimer:
432+  5594 3A 90 52         ld  A,(currentCh)        ;включить канал
433+  5597 D3 08            OUT  (08),a       ;
434+  5599 2A A5 55         ld hl,(chBuffer)
434+  559C 36 01          ld (hl),1;enable ch
435+  559E 2A 09 52         ld hl,(currentTick)
436+  55A1                  ;и сразу поиграть следующую ноту
437+  55A1 7E               ld a,(hl)
437+  55A2 E6 7F          and 01111111b
438+  55A4              playNote:
439+  55A4                  ;кладем ноту в буффер для проигрывания
440+  55A4              chBuffer EQU $+1
441+  55A4 21 91 52         ld hl,notesBuffer
442+  55A7 23               inc hl  ;+1
443+  55A8 77               ld (hl),a;note
444+  55A9                  ;сбрасываем счетчик на старт - или из комманды 5
445+  55A9 23               inc hl
445+  55AA 23             inc hl
446+  55AB 7E               ld a,(hl);берем оффсет
447+  55AC 23               inc hl
448+  55AD 77               ld (hl),a;сохраняем позицию старта для офсета
449+  55AE                  ;ld (hl),0;!!!!!!!!!!!!!!!!!!!!!!!
450+  55AE              nextNote:
451+  55AE                  ;переходим дальше
452+  55AE 2A 09 52         ld hl,(currentTick)
452+  55B1 23             inc hl
452+  55B2 22 09 52       ld (currentTick),hl
453+  55B5 C9               ret
454+  55B6
455+  55B6              ;in a - patern number
456+  55B6              getNextPatternAddr:
457+  55B6                  ;to next pat in play order
458+  55B6 3A 0B 52         ld a,(currentPattern)
458+  55B9 3C             inc a
458+  55BA 32 0B 52       ld (currentPattern),a
459+  55BD              getPatternAddr:
460+  55BD                  ;get new pat index from play order
461+  55BD 5F               ld e,a
461+  55BE 16 00          ld d,0
461+  55C0 2A 02 52       ld hl,(playOrder)
461+  55C3 19             add hl,de
461+  55C4 7E             ld a,(hl)
462+  55C5 6F               ld l,a;save a
463+  55C6 B7               or a
463+  55C7 17             rla ;check for bit 7
464+  55C8 D2 D4 55         jp nc,1f
465+  55CB 7D               ld a,l
465+  55CC E6 7F          and 01111111b
465+  55CE 32 0B 52       ld (currentPattern),a
465+  55D1 C3 BD 55       jp getPatternAddr
466+  55D4              1:
467+  55D4 7D               ld a,l;restore a
468+  55D5
469+  55D5                  ;get pat addr from table
470+  55D5 87               add a,a
470+  55D6 16 00          ld d,0
470+  55D8 5F             ld e,a
470+  55D9 2A 00 52       ld hl,(patterns)
470+  55DC 19             add hl,de
471+  55DD 7E               ld a,(hl)
471+  55DE 23             inc hl
471+  55DF 66             ld h,(hl)
471+  55E0 6F             ld l,a
472+  55E1              notes equ $+1
473+  55E1 11 00 00         ld de,00000
473+  55E4 19             add hl,de
474+  55E5 C9               ret
# file closed: player.a80
 10   55E6              module:
 11   55E6              	incbin "music\music.vtk"
 12   5CA8              	savebin "player.bin",begin,$-begin
 13   5CA8
 14   5CA8
 15   5CA8
# file closed: main.asm
